name: Build Preview

# Trigger on push to develop branch or manual dispatch
on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        type: choice
        default: 'android'
        options:
          - android
          - ios
      profile:
        description: 'Build profile'
        required: true
        type: choice
        default: 'staging'
        options:
          - staging
          - preview

jobs:
  build:
    name: Build Preview - ${{ github.event.inputs.platform || 'android' }}
    runs-on: ${{ github.event.inputs.platform == 'ios' && 'macos-latest' || 'ubuntu-latest' }}
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'yarn'

      - name: ðŸ”§ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: â˜• Setup Java (Android)
        if: github.event.inputs.platform != 'ios'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ“¥ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ðŸ” Decrypt environment keys
        run: |
          PROFILE=${{ github.event.inputs.profile || 'staging' }}
          # If GPG decryption is set up
          if [ -f "config/encrypted/keys.$PROFILE.json.gpg" ]; then
            gpg --quiet --batch --yes --decrypt --passphrase="${{ secrets.GPG_PASSPHRASE }}" \
              --output "keys.$PROFILE.json" "config/encrypted/keys.$PROFILE.json.gpg"
          fi
        continue-on-error: true

      - name: ðŸ“ Get version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ðŸ“± Build Locally
        run: |
          PROFILE=${{ github.event.inputs.profile || 'staging' }}
          PLATFORM=${{ github.event.inputs.platform || 'android' }}
          eas build --platform $PLATFORM --profile $PROFILE --local --non-interactive --output ./build-output
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“¦ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-${{ github.event.inputs.platform || 'android' }}-${{ steps.version.outputs.version }}
          path: build-output
          retention-days: 7

      - name: ðŸ’¬ Comment PR with download link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const platform = '${{ github.event.inputs.platform || 'android' }}';
            const version = '${{ steps.version.outputs.version }}';
            const message = `## ðŸš€ Preview Build Complete
            
            **Platform:** ${platform}
            **Version:** ${version}
            **Profile:** ${{ github.event.inputs.profile || 'staging' }}
            
            ðŸ“¥ Download from the Actions artifacts tab`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

